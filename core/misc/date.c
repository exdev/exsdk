// ======================================================================================
// File         : date.c
// Author       : Wu Jie 
// Last Change  : 12/30/2010 | 20:21:29 PM | Thursday,December
// Description  : 
// ======================================================================================

///////////////////////////////////////////////////////////////////////////////
// includes
///////////////////////////////////////////////////////////////////////////////

#include "exsdk.h"

///////////////////////////////////////////////////////////////////////////////
// defines
///////////////////////////////////////////////////////////////////////////////

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static const char *__month_name[12] = {
    "Jan", "Feb", "Mar", "Apr", "May", "Jun", 
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
};

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static const char *__week_name[7] = {
    "Mon", "Tues", "Wed", "Thur", "Fri", "Sat", "Sun",
};

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

static const uint8 __month_days[12] = { 
    31,28,31,30,31,30,31,31,30,31,30,31 
};

///////////////////////////////////////////////////////////////////////////////
// function defines
///////////////////////////////////////////////////////////////////////////////

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

const char *ex_week_day_name ( uint _wday ) {
    ex_assert_return ( _wday >= 1 && _wday <= 7, "invalid", "invalid weekday input" );
    return __week_name[_wday-1];
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

const char *ex_month_name ( uint _month ) {
    ex_assert_return ( _month >= 1 && _month <= 12, "invalid", "invalid month input" );
    return __month_name[_month];
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

bool ex_is_valid_date ( uint _year, uint _month, uint _day ) {
    if ( _month<1 || _month>12 || _day<1 || _day>31 )
        return false;
    return true;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

bool ex_is_leap_year ( uint _year ) {
    return ((_year%4==0) && (_year%100!=0)) || (_year%400==0);
}

// ------------------------------------------------------------------ 
// Desc: 
// NOTE: the input y,m,d must be int
// ------------------------------------------------------------------ 

static void __greg2jul ( uint *_out_jul, int _year, int _month, int _day ) {
    if( !ex_is_valid_date ( _year, _month, _day ) ) {
        ex_warning ( "can't set date (%dy,%dm,%dd). the value is invalid!", _year, _month, _day );
        *_out_jul = 0;
        return;
    }

    *_out_jul = (1461*(_year+4800+(_month-14)/12))/4+(367*(_month-2-12*((_month-14)/12)))/12-(3*((_year+4900+(_month-14)/12)/100))/4+_day-32075;
}

// ------------------------------------------------------------------ 
// Desc: 
// NOTE: the input y,m,d must be int
// ------------------------------------------------------------------ 

static void __jul2greg ( uint _jul, int *_out_year, int *_out_month, int *_out_day ) {
    register int l,n,i,j;
    l=_jul+68569;
    n=(4*l)/146097;
    l=l-(146097*n+3)/4;
    i=(4000*(l+1))/1461001;
    l=l-(1461*i)/4+31;
    j=(80*l)/2447;
    if ( _out_day )
        *_out_day=l-(2447*j)/80;
    l=j/11;
    if ( _out_month )
        *_out_month=j+2-(12*l);
    if (_out_year)
        *_out_year=100*(n-49)+i+l;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

date_t ex_date_from ( uint _year, uint _month, uint _day ) {
    date_t date;
    __greg2jul( &date, _year, _month, _day);
    return date;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

void ex_date_to ( date_t _date, int *_year, int *_month, int *_day ) {
    __jul2greg ( _date, _year, _month, _day );
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

uint ex_date_day_of_week ( date_t _date ) {
    return (_date+1) % 7;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

uint ex_date_day_of_year ( date_t _date ) {
    int y;
    uint jd;
    __jul2greg ( _date, &y, NULL, NULL );
    __greg2jul ( &jd, y, 1, 1 );

    return _date-jd+1;
}

// ------------------------------------------------------------------ 
// Desc: 
// ------------------------------------------------------------------ 

uint ex_date_days_in_month ( date_t _date ) {
    int y,m;
    __jul2greg ( _date, &y, &m, NULL );

    if( m==2 && ex_is_leap_year(y) )
        return 29;

    return __month_days[m-1];
}
